## Part 1. Инструмент ipcalc
### 1.1. Сети и маски

- ![](screenshots/ipcalc1.png)<br/>
Установка утилиты **ipcalc**
  
- ![](screenshots/ipcalc2.png)<br/>
Адрес сети: 192.160.0.0/13
- ![](screenshots/ipcalc3.png)<br/>
перевод маски 255.255.255.0 в префиксную и двоичную запись:<br/>
    - префиксная: 24
    - двоичная: 11111111.11111111.11111111.00000000

- ![](screenshots/ipcalc4.png)<br/>
перевод маски /15 в обычную и двоичную:
    - обычная: 255.254.0.0
    - двоичная: 11111111.11111110.00000000.00000000

-  ![](screenshots/ipcalc5.png)<br/>
перевод маски 11111111.11111111.11111111.11110000 в обычную и префиксную:
    - обычная: 255.255.255.240
    - префиксная: 28
- минимальный и максимальный хост в сети 12.167.38.4 при масках:
    - /8:<br/> ![](screenshots/ipcalc_3_1.png)<br/>
    - 11111111.11111111.00000000.00000000:<br/> ![](screenshots/ipcalc_3_4.png)<br/>
    - 255.255.254.0:<br/> ![](screenshots/ipcalc_3_3.png)<br/>
    - /4:<br/> ![](screenshots/ipcalc_3_2.png)<br/>

### 1.2. localhost
Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: 
- На следующих скриншотах видно, какие из адресов относятся к сети localhost:\
![](screenshots/ipcalc_4_1.png)<br/>
![](screenshots/ipcalc_4_2.png)<br/>
    - 194.34.23.100: нет
    - 127.0.0.2: да 
    - 127.1.0.1: да
    - 128.0.0.1: нет

### 1.3. Диапазоны и сегменты сетей
1. 
    - публичные: 134.43.0.2, 172.0.2.1, 192.172.0.1, 172.68.0.2, 192.169.168.1
    - частные: 10.0.0.45, 192.168.4.2, 172.20.250.4, 172.16.255.255, 10.10.10.10 
2. 
    - какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18: 10.0.0.1, 10.10.0.2, 10.10.10.10, 10.10.100.1, 10.10.1.255
    - Ответ: 10.10.0.2, 10.10.10.10, 10.10.1.255

## Part 2. Статическая маршрутизация между двумя машинами
- Сетевые интерфейсы *ws1* (команда **ip a**)\
![](screenshots/part_2_1.png)<br/>
- Сетевые интерфейсы *ws2* (команда **ip a**)\
![](screenshots/part_2_2.png)<br/>

- Адреса и маски: ws1 - 192.168.100.10, маска /16, ws2 - 172.24.116.8, маска /12:\
![](screenshots/part_2_3_2.png)<br/>


- Команда **netplan apply** для перезапуска сервиса сети:\
![](screenshots/part_2_4.png)<br/>

### 2.1. Добавление статического маршрута вручную
- Настройка статического маршрута вручную *ws1*\
![](screenshots/part_2_5_2.png)<br/>
- Настройка статического маршрута вручную *ws2*\
![](screenshots/part_2_5_1.png)<br/>

### 2.2. Добавление статического маршрута с сохранением
- Добавление статического маршрута от одной машины до другой с помощью файла /etc/netplan/00-installer-config.yaml:\
![](screenshots/part_2_6.png)<br/>
- Проверка соединения между машинами:\
![](screenshots/part_2_7.png)<br/>

## Part 3. Утилита iperf3
### 3.1. Скорость соединения
- 8 Mbps = 1 MB/s
- 100 MB/s = 800000 Kbps
- 1 Gbps = 1000 Mbps

### 3.2. Утилита iperf3
- Установить утилиты на обоих машинах\
![](screenshots/part_3_1.png)<br/>

- На одной из машин запустить iperf3 в режиме сервера, который будет слушать входящие соединения и отвечать на них. Для этого ввести команду:\
**iperf3 -s**\
![](screenshots/part_3_2.png)<br/>

- На другой машине запустить iperf3 в режиме клиента и указать адрес сервера. Для этого ввести команду:\
**iperf3 -c <ip-адрес сервера>**\
![](screenshots/part_3_3.png)<br/>

- Cкорость соединения между ws1 и ws2:
 1.32 Gbits/sec

- По умолчанию, iperf3 будет отправлять данные на сервер в течение 10 секунд и затем выводить отчет о скорости передачи данных. Если нужно изменить время передачи данных, можно использовать флаг -t и указать желаемое время в секундах. Например, чтобы отправить данные в течение 30 секунд:
**iperf3 -c 192.168.100.10 -t 30**

- Результаты скорости передачи данных  отображаются в столбце Bitrate после завершения теста. Можно получить более подробный отчет о тесте, используя определенные опции командной строки, такие как -r или -R.

## Part 4. Сетевой экран
### 4.1. Утилита iptables
- Ключи **iptables**:\
    - -A: добавить правило в конец цепочки
    - -C: проверить существование правила в цепочке
    - -D: удалить правило из цепочки
    - -E: изменить имя пользовательской цепочки
    - -F: очистить цепочку от всех правил
    - -I: вставить правило в начало цепочки
    - -L: вывести список правил в цепочке
    - -N: создать новую пользовательскую цепочку
    - -X: удалить пользовательскую цепочку
    - -Z: сбросить счетчики пакетов и байтов для всех правил в цепочке
    - -P: установить политику по умолчанию для цепочки
    - -p: указать протокол (tcp, udp, icmp и т.д.)
    - -s: указать исходный IP-адрес
    - -d: указать целевой IP-адрес
    - --sport: указать исходный порт
    - --dport: указать целевой порт
    - -j: указать целевое действие (ACCEPT, DROP, REJECT и т.д.)
    - -i: указать сетевой интерфейс входящего трафика
    - -o: указать сетевой интерфейс исходящего трафика
    - -m: указать модуль расширения (например, mod_tcpudp для фильтрации по портам TCP и UDP)
    - -v: выводить детальную информацию о правилах
    - -h: вывести справку о команде

- Посмотреть состояние iptables:\
**sudo iptables -L -nv**
- Посмотреть состояние таблицы:\
**sudo iptables -t <имя таблицы> -L -nv**
- Файл /etc/firewall.sh, имитирующий фаерволл, на ws1 и ws2:\
![](screenshots/part_4_1.png)<br/>
- Запуск файлов firewall.sh:\
![](screenshots/part_4_2.png)<br/>
- Состояние таблицы filter:\
![](screenshots/part_4_3.png)<br/>
- Машина ws1 не сможет отправлять echo-reply пакеты, но сможет принимать их, тогда как машина ws2 сможет отправлять эти пакеты, но не сможет принимать их.

- В обоих случаях отрабатывается верхнее правило (DROP для ws1 и ACCEPT для ws2). 

- Если пакет соответствует только верхнему правилу в цепочке, то будет выполнено только это правило. Однако, если пакет соответствует нескольким правилам в цепочке, то будет выполнено только первое правило, которое соответствует пакету.

- Если нужно, чтобы пакет, соответствующий более чем одному правилу, был обработан несколькими правилами, можно использовать цепочки пользовательского определения (user-defined chains) в iptables, где каждое правило может перенаправлять пакеты в другие цепочки.

### 4.2. Утилита nmap

- Командой ping находим машину, которая не "пингуется", после чего утилитой nmap показываем, что хост машины запущен:\
![](screenshots/part_4_4.png)<br/>
- В выводе nmap сказано: *Host is up*
- Сохранение дампа образа виртуальной машины ws1\
![](screenshots/part_4_5.png)<br/>

- Сохранение дампа образа виртуальной машины ws2\
![](screenshots/part_4_6.png)<br/>

## Part 5. Статическая маршрутизация сети
- Пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2)):\
![](screenshots/part_5_1.png)<br/>

### 5.1. Настройка адресов машин
- файл etc/netplan/00-installer-config.yaml для r1:\
![](screenshots/part_5_2_0.png)<br/>

- файл etc/netplan/00-installer-config.yaml для r2:\
![](screenshots/part_5_2_2.png)<br/>

- файл etc/netplan/00-installer-config.yaml для ws11:\
![](screenshots/part_5_2_3.png)<br/>

- файл etc/netplan/00-installer-config.yaml для ws21:\
![](screenshots/part_5_2_4.png)<br/>

- файл etc/netplan/00-installer-config.yaml для ws22:\
![](screenshots/part_5_2_5.png)<br/>

- Перезапуск сервиса сети на каждой машине следующей командой:\
![](screenshots/part_5_3.png)<br/>

- Командой ip -4 a проверяем, что адрес машины r1 задан верно:\
![](screenshots/part_5_4_2.png)<br/>

- Командой ip -4 a проверяем, что адрес машины r2 задан верно:\
![](screenshots/part_5_4_3.png)<br/>

- Командой ip -4 a проверяем, что адрес машины ws11 задан верно:\
![](screenshots/part_5_4_5.png)<br/>

- Командой ip -4 a проверяем, что адрес машины ws21 задан верно:\
![](screenshots/part_5_4_1.png)<br/>

- Командой ip -4 a проверяем, что адрес машины ws22 задан верно:\
![](screenshots/part_5_4_4.png)<br/>

- Пропинговать ws22 с ws21:\
![](screenshots/part_5_5_1.png)<br/>

- Пропинговать r1 с ws11:\
![](screenshots/part_5_5_2.png)<br/>

### 5.2. Включение переадресации IP-адресов

- Включения переадресации IP до конца сессии:\
![](screenshots/part_5_6.png)<br/>

- Включения переадресации IP на постоянной основе:\
    - для r1:\
    ![](screenshots/part_5_7_1.png)<br/>
    - для r2:\
    ![](screenshots/part_5_7_2.png)<br/>

### 5.3. Установка маршрута по-умолчанию
- Настройка маршрута по умолчанию для рабочих станций:
    - ws11:\
    ![](screenshots/part_5_8_1.png)<br/>
    - ws21:\
    ![](screenshots/part_5_8_3.png)<br/>
    - ws22:\
    ![](screenshots/part_5_8_2.png)<br/>

- Маршрут добавился в таблицу маршрутизации, проверим это командой **ip r**:\
![](screenshots/part_5_9.png)<br/>

- Пропингуем с ws11 роутер r2:\
![](screenshots/part_5_10.png)<br/>

- Используем команду **tcpdump -tn -i eth1**, что бы посмотреть, что пинг доходит:\
![](screenshots/part_5_11.png)<br/>

### 5.4. Добавление статических маршрутов

- Cтатические маршруты в файле конфигураций:
    - r1:\
    ![](screenshots/part_5_12_1.png)<br/>
    - r2:\
    ![](screenshots/part_5_12_2.png)<br/>
    
- Таблицы с маршрутами на r1 и r2:\
![](screenshots/part_5_12_3.png)<br/>

- Запустить команды на ws11:\
**ip r list 10.10.0.0/[маска сети]** и **ip r list 0.0.0.0/0**\
![](screenshots/part_5_13.png)<br/>
- Для адреса 10.10.0.0/[маска сети] был выбран маршрут, отличный от 0.0.0.0/0, потому что он является более специфическим. 0.0.0.0/0 (маршрут по умолчанию) используется, если не было найдено других подходящих маршрутов для перенаправления трафика.

### 5.5. Построение списка маршрутизаторов
- Вызов **tcpdump**:\
![](screenshots/part_5_14_3.png)<br/>

- Вывод **tcpdump**:\
![](screenshots/part_5_14_2.png)<br/>

- Вызов и вывод **traceroute**:\
![](screenshots/part_5_14_1.png)<br/>

- Traceroute отправляет пакеты с различными значениями TTL (Time to Live), начиная с 1 (по 3 раза каждый пакет, что бы уменьшить погрешность во времени, которая может возникнуть, например, из за нагрузки сети), и записывает IP-адреса промежуточных маршрутизаторов, через которые проходят эти пакеты. Когда TTL пакета истекает (декремент на каждом маршрутизаторе), маршрутизатор отправляет обратно ICMP-сообщение "Time Exceeded" отправителю, который затем использует эту информацию, чтобы определить IP-адрес маршрутизатора на пути до конечного узла.\
Анализируя вывод команды дампа на r1, можно увидеть, какие пакеты проходят через интерфейс enp0s3 маршрутизатора. В выводе отображаются исходный и назначенный IP-адреса, номера портов, длина пакета и т.д. Анализируя эту информацию, можно понять, какие пакеты проходят через маршрутизатор и на каком этапе пути они находятся.

### 5.6. Использование протокола ICMP при маршрутизации

- Пропинговать с ws11 несуществующий IP:\
**ping -c 1 10.30.0.11**\
![](screenshots/part_5_15_2.png)<br/>

- На r1 перехват сетевого трафика:\
![](screenshots/part_5_15_1.png)<br/>


## Part 6. Динамическая настройка IP с помощью DHCP

- Для r2 настроить в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:\
    - dhcpd.conf адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети:\
    ![](screenshots/part_6_1_1.png)<br/>
    - resolv.conf прописать nameserver 8.8.8.8:\
    ![](screenshots/part_6_1_2.png)<br/>

- Перезагрузить службу DHCP командой systemctl restart isc-dhcp-server:\
    ![](screenshots/part_6_2_1.png)<br/>
- Машину ws21 перезагрузить при помощи reboot:\
    ![](screenshots/part_6_2_2.png)<br/>
- Через ip a показать, что она получила адрес. Также пропинговать ws22 с ws21:\
    ![](screenshots/part_6_2_3.png)<br/>

- MAC адрес у ws11, etc/netplan/00-installer-config.yaml, добавляем строки: macaddress: 10:10:10:10:10:BA, dhcp4: true:\
    ![](screenshots/part_6_3_1.png)<br/>

    
- Для r1 настроить в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:\
    - dhcpd.conf адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети:\
    ![](screenshots/part_6_4_2.png)<br/>
    - Cделать выдачу адресов с жесткой привязкой к MAC-адресу:\
    ![](screenshots/part_6_4_1.png)<br/>
    - resolv.conf прописать nameserver 8.8.8.8:\
    ![](screenshots/part_6_4_3.png)<br/>

- Перезагрузить службу DHCP командой systemctl restart isc-dhcp-server:\
    ![](screenshots/part_6_4_4.png)<br/>

- Машину ws11 перезагрузить при помощи reboot:\
    ![](screenshots/part_6_4_5.png)<br/>
- Через ip a показать, что она получила адрес. Также пропинговать ws11 с ws22:\
    ![](screenshots/part_6_4_7.png)<br/>

- Запросить с ws21 обновление ip адреса и посмотреть адрес до и после командой **ip a**:\
    ![](screenshots/part_6_5.png)<br/>
 


- Когда вы запускаете команду dhclient или когда загружаете компьютер, dhclient отправляет широковещательные сообщения (DHCP Discover) в подсети для обнаружения доступных DHCP-серверов. Пакет DHCP Discover включает в себя MAC-адрес физического компьютера для клиента, который будет идентифицирован сервером. Затем сервер DHCP отправляет ответ (ПРЕДЛОЖЕНИЕ DHCP) с предложением отправить IP-адрес. Клиент отвечает пакетом запроса или запросом DHCP, принимая предложение. Затем DHCP-сервер назначает клиенту IP-адрес, интегрируя его в сеть. Этот процесс известен как согласование DHCP.\
Что касается пакетов, мы можем резюмировать этот процесс как DHCPDISCOVER> DHCPOFFER> DHCPREQUEST> DHCPACK, где:\
DHCPDISCOVER: клиент отправляет пакет в подсети в поисках доступных DHCP-серверов для получения IP-адреса.\
DHCPOFFER: когда пакет получен DHCP-сервером, сервер отправляет сообщение DHCPOFFER обратно клиенту, идентифицированному его MAC-адресом, а затем предлагает назначить ему свободный или неиспользуемый IP-адрес.\
DHCPREQUEST: клиент отправляет пакет DHCP-серверу, принимая предложение. Если более одного DHCP-сервера предлагали IP-адрес, клиент примет первый полученный, а другие DHCP-серверы будут уведомлены о том, что первоначальный запрос уже был удовлетворен.\
DHCPACK: Наконец, после того, как DHCP-сервер получил последний пакет запроса от клиента. Он ответит пакетом DHCPACK, завершающим назначение IP.

- Опции, которыми пользуется DHCP сервер при запросе на смену IP от клиента (используется команда **sudo tcpdump -i enp0s3 -vvv port 67 or port 68 -e -n**):\
    ![](screenshots/part_6_option.png)<br/>

- Список опций, которые использует DHCP-сервер и их значение:

    - Server-ID Option 54: IP-адрес DHCP-сервера - 10.20.0.1
    - Requested-IP Option 50: запрошенный клиентом IP-адрес - 10.20.0.15
    - Hostname Option 12: имя компьютера клиента - "tiaraurz2"
    - Subnet-Mask Option 1: маска подсети - 255.255.255.192
    - Default-Gateway Option 3: IP-адрес шлюза по умолчанию - 10.20.0.1
    - Domain-Name Option 15: имя домена - "example.org"
    - Domain-Name-Server Option 6: IP-адрес DNS-сервера - 10.20.0.1
    - Lease-Time Option 51: время аренды IP-адреса - 600 секунд
    - OHCP-Message Option 53: тип сообщения DHCP-протокола - Request или ACK
    - Parameter-Request (Option 55): список запрошенных параметров, включая маску подсети, шлюз по умолчанию, DNS-серверы и другие;
    - Опция 255 с кодом 0xFF является специальной опцией "END", которая указывает на конец списка опций. Она используется для указания, что больше опций в данном сообщении DHCP не будет.
    - Опция 0 с кодом 0x00 - это опция "PAD" (заполнитель), которая используется для выравнивания опций в сообщении DHCP до кратности 4 байтам. Она состоит только из нулевых байтов и не имеет полезной информации.

## Part 7. NAT
- Когда в конфигурационном файле Apache была указана строка "Listen 80", это означало, что сервер Apache слушает входящие соединения на порту 80 только на одном конкретном сетевом интерфейсе (обычно это был локальный интерфейс - 127.0.0.1). Это ограничивало возможности сервера Apache и могло привести к тому, что клиенты не могли бы подключиться к серверу Apache с других компьютеров в сети.
Когда в конфигурационном файле Apache указывается строка "Listen 0.0.0.0:80", это означает, что сервер Apache будет слушать входящие соединения на порту 80 на всех доступных сетевых интерфейсах, включая локальный интерфейс и внешние интерфейсы, если они настроены на сервере. Это позволяет клиентам подключаться к серверу Apache с других компьютеров в сети и расширяет возможности сервера Apache.
Сделаем Apache общедоступным на ws22 и r1:\
![](screenshots/part_7_1.png)<br/>

- Запустить веб-сервер Apache командой **service apache2 start** на ws22 и r1:\
![](screenshots/part_7_2.png)<br/>

- Добавить в фаервол на r2 следующие правила:
    1) Удаление правил в таблице filter - iptables -F
    2) Удаление правил в таблице "NAT" - iptables -F -t nat
    3) Отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP
    ![](screenshots/part_7_3.png)<br/>

- Запускаем командой **./firewall.sh**
- Проверка соединения командой ping между ws22 и r1:
    - До запуска firewall на r2:\
    ![](screenshots/part_7_4_1.png)<br/>
    ![](screenshots/part_7_4_2.png)<br/>
    - После запуска firewall на r2:\
    ![](screenshots/part_7_4_3.png)<br/>
    ![](screenshots/part_7_4_4.png)<br/>

- Разрешить маршрутизацию всех пакетов протокола ICMP на r2:\
    ![](screenshots/part_7_5.png)<br/>

- Проверка соединения командой ping между ws22 и r1:\
    ![](screenshots/part_7_6_1.png)<br/>
    ![](screenshots/part_7_6_2.png)<br/>

- SNAT и DNAT правила:\
    ![](screenshots/part_7_7_1.png)<br/>

- Проверка через telnet:\
    ![](screenshots/part_7_7_2.png)<br/>


## Part 8. Дополнительно. Знакомство с SSH Tunnels

- Запустить на r2 фаервол с правилами из Части 7:\
    ![](screenshots/part_7_7_1.png)<br/>

- Запустить веб-сервер Apache на ws22 только на localhost:\
    ![](screenshots/part_8_2.png)<br/>

- Воспользоваться Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21 (локальный порт: 8080):\
    ![](screenshots/part_8_3.png)<br/>

- Чтобы осуществить проброс портов, потребуется создание SSH tunnel. Для этого в локальной системе открывается порт, а для создания канала связи пользователь должен выбрать порт на другом конце туннеля.\
Команда устанавливает прослушку на порт 8080. Порт 80 используется для проброса.

- Проверка подключения командой **telnet 127.0.0.1 8080** на ws21:\
    ![](screenshots/part_8_4.png)<br/>



- Воспользоваться Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11 (на ws22 вводим команду):\
    ![](screenshots/part_8_5.png)<br/>

- Удаленное TCP-пробрасывание (remote TCP forwarding) - это метод перенаправления TCP-трафика через зашифрованное соединение, используя протокол SSH. Это может быть полезным, когда вам нужно получить доступ к сервису, который работает на удаленном сервере, и этот сервис не доступен напрямую из-за ограничений на маршрутизации или защиты.\
Для использования удаленного TCP-пробрасывания вы должны установить SSH-соединение с удаленным сервером с опцией -R (remote port forwarding). Например, если вы хотите получить доступ к веб-серверу на порту 80 на удаленном сервере, вы можете использовать следующую команду:\
**ssh -R 3001:localhost:80 user@remote_server**\
Эта команда привяжет порт 3001 на удаленном сервере к порту 80 на локальном сервере (localhost), где запущен SSH-клиент.

- Проверка подключения на ws11:\
    ![](screenshots/part_8_6.png)<br/>